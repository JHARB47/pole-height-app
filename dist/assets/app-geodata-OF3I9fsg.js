const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-Cv8-97MN.js","assets/polyfills-CELajPCl.js"])))=>i.map(i=>d[i]);
import{_ as b}from"./app-calculator-BxQMOd7r.js";import{J as v}from"./zip-utils-BoTj1NZG.js";function y(e,n){if(!e||!n)return;const t={road:e.envRoadFt,residential:e.envResidentialFt,pedestrian:e.envPedestrianFt,field:e.envFieldFt,residentialYard:e.envResidentialYardFt,residentialDriveway:e.envResidentialDrivewayFt,nonResidentialDriveway:e.envNonResidentialDrivewayFt,waterway:e.envWaterwayFt,wvHighway:e.envWVHighwayFt,interstate:e.envInterstateFt,interstateNewCrossing:e.envInterstateNewCrossingFt,railroad:e.envRailroadFt}[n];return Number.isFinite(t)?Number(t):void 0}function S(e,n,o){if(!Array.isArray(n)||!n.length){const r=y(e,o);return Number.isFinite(r)?Number(r):null}let t=0;for(const r of n){const i=y(e,(r==null?void 0:r.env)||o);Number.isFinite(i)&&(t=Math.max(t,Number(i)))}return t||null}function f(e){const n=typeof e=="number"?e:Number(e);return Number.isFinite(n)?n:void 0}function F(e,n){var t,r,i,s,u,l,c,d,a,p,g;const o={id:e.id||"",jobId:e.jobId||n.id||"",status:e.status||"draft",height:(t=e.height)!=null?t:"",poleClass:(r=e.poleClass)!=null?r:"",powerHeight:(i=e.powerHeight)!=null?i:"",voltage:(s=e.voltage)!=null?s:"",hasTransformer:!!e.hasTransformer,spanDistance:(u=e.spanDistance)!=null?u:"",adjacentPoleHeight:(l=e.adjacentPoleHeight)!=null?l:"",attachmentType:e.attachmentType||"communication",timestamp:e.timestamp||"",commCompany:n.commCompany||"",incomingBearingDeg:(c=e.incomingBearingDeg)!=null?c:"",outgoingBearingDeg:(d=e.outgoingBearingDeg)!=null?d:"",PULL_ft:(a=e.PULL_ft)!=null?a:""};return((p=e.asBuilt)==null?void 0:p.attachHeight)!=null&&(o.asBuiltAttach=e.asBuilt.attachHeight),((g=e.asBuilt)==null?void 0:g.powerHeight)!=null&&(o.asBuiltPower=e.asBuilt.powerHeight),e._varianceIn!=null&&(o.varianceIn=e._varianceIn),e._variancePass!=null&&(o.variancePass=e._variancePass),o}function N(e){const n=new Map;for(const o of e){const t=f(o.latitude),r=f(o.longitude);Number.isFinite(t)&&Number.isFinite(r)&&o.id&&n.set(String(o.id),[r,t])}return n}function P(e={}){var s,u,l,c,d;const{poles:n=[],spans:o=[],job:t={}}=e,r=[];for(const a of n){const p=f(a.latitude),g=f(a.longitude);if(!Number.isFinite(p)||!Number.isFinite(g))continue;const w=F(a,t);r.push({type:"Feature",properties:w,geometry:{type:"Point",coordinates:[g,p]}})}const i=N(n);for(const a of o){const p=a.fromId!=null?i.get(String(a.fromId)):void 0,g=a.toId!=null?i.get(String(a.toId)):void 0;if(!p||!g)continue;const w={id:a.id||"",jobId:t.id||"",lengthFt:(s=a.length)!=null?s:"",proposedAttach:(u=a.proposedAttach)!=null?u:"",environment:a.environment||"",incomingBearingDeg:(l=a.incomingBearingDeg)!=null?l:"",outgoingBearingDeg:(c=a.outgoingBearingDeg)!=null?c:"",PULL_ft:(d=a.PULL_ft)!=null?d:""};r.push({type:"Feature",properties:w,geometry:{type:"LineString",coordinates:[p,g]}})}return{type:"FeatureCollection",features:r}}function h(e,n,o="application/octet-stream"){if(typeof window=="undefined"||typeof document=="undefined")throw new Error("downloadText can only run in a browser environment.");const t=new Blob([n],{type:o}),r=URL.createObjectURL(t),i=document.createElement("a");i.href=r,i.download=e,i.click(),URL.revokeObjectURL(r)}function m(e,n="geodata.geojson"){h(n,JSON.stringify(e,null,2),"application/geo+json")}async function _(e,n="geodata.kml"){var o;try{const t=await b(()=>import("./vendor-Cv8-97MN.js").then(s=>s.i),__vite__mapDeps([0,1])),i=((o=t.default)!=null?o:t)(e,{documentName:"PolePlan Pro",name:"id",description:"jobId"});h(n,i,"application/vnd.google-earth.kml+xml")}catch(t){console.error("Error exporting KML, falling back to GeoJSON",t),m(e,n.replace(/\.kml$/,".geojson"))}}async function j(e,n="geodata.kmz"){var o;if(typeof window=="undefined"||typeof document=="undefined")return console.warn("KMZ export is browser-only; falling back to GeoJSON."),m(e,n.replace(/\.kmz$/,".geojson"));try{const t=await b(()=>import("./vendor-Cv8-97MN.js").then(d=>d.i),__vite__mapDeps([0,1])),i=((o=t.default)!=null?o:t)(e,{documentName:"PolePlan Pro",name:"id",description:"jobId"}),s=new v;s.file("doc.kml",i);const u=await s.generateAsync({type:"blob"}),l=URL.createObjectURL(u),c=document.createElement("a");c.href=l,c.download=n,c.click(),URL.revokeObjectURL(l)}catch(t){console.error("Error exporting KMZ, falling back to GeoJSON",t),m(e,n.replace(/\.kmz$/,".geojson"))}}async function k(e,n="geodata-shapefile.zip",o=!0){const t={type:"FeatureCollection",features:e.features||[]},r={folder:"poleplanwizard",types:{point:"poles",line:"spans",polygon:"areas"}};try{const i=await L();if(!i)throw new Error("shpwrite not available");if(o)return i.download(t,r),new Blob([JSON.stringify(t)],{type:"application/json"});const s=i.zip(t,r),u=atob(s),l=u.length,c=new Uint8Array(l);for(let d=0;d<l;d++)c[d]=u.charCodeAt(d);return new Blob([c],{type:"application/zip"})}catch(i){return console.warn("Shapefile export unavailable; falling back to GeoJSON.",i),o&&m(e,n.replace(/\.zip$/,".geojson")),new Blob([JSON.stringify(e)],{type:"application/json"})}}async function L(){if(typeof window=="undefined")return;if(window.shpwrite)return window.shpwrite;const e=["https://unpkg.com/@mapbox/shp-write@0.4.3/dist/shpwrite.js","https://cdn.jsdelivr.net/npm/@mapbox/shp-write@0.4.3/dist/shpwrite.js"];let n;for(const o of e)try{if(await new Promise((t,r)=>{const i=document.createElement("script");i.src=o,i.async=!0,i.referrerPolicy="no-referrer",i.crossOrigin="anonymous",i.onload=()=>t(void 0),i.onerror=()=>r(new Error("Failed to load shpwrite from CDN: "+o)),document.head.appendChild(i)}),window.shpwrite)return window.shpwrite}catch(t){n=t}throw n||new Error("Failed to load shpwrite from all CDNs")}const B=Object.freeze(Object.defineProperty({__proto__:null,buildGeoJSON:P,downloadText:h,exportGeoJSON:m,exportKML:_,exportKMZ:j,exportShapefile:k},Symbol.toStringTag,{value:"Module"}));export{S as c,B as g};
//# sourceMappingURL=app-geodata-OF3I9fsg.js.map

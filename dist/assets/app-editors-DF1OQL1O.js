import{R,j as e}from"./react-CcDwFy_c.js";import{u as ge,W as he}from"./app-utils-BDwnIIkN.js";import{p as B,a as je,b as ve,f as Z,c as ie}from"./app-calculations-BTm-MLQ7.js";import{P as xe}from"./vendor-Cv8-97MN.js";import{c as Ne}from"./app-geodata-OF3I9fsg.js";const Ce=[{label:"Communication",value:"communication"},{label:"Drop (Comm)",value:"drop"},{label:"Neutral",value:"neutral"},{label:"Power Secondary",value:"secondary"}];function Re(){const{existingLines:s,setExistingLines:y,csvLineMapping:M,setCsvLineMapping:Y,useTickMarkFormat:P}=ge(),J=P?je:ve,[G,$]=R.useState(!1),[F,b]=R.useState(""),[C,H]=R.useState(!1),[O,U]=R.useState([]),q=o=>{const h=[];let c=0,t="",n=[],a=!1;const l=()=>{n.push(t),t=""},r=()=>{n.length&&h.push(n),n=[]};for(;c<o.length;){const m=o[c];a?m==='"'?o[c+1]==='"'?(t+='"',c++):a=!1:t+=m:m==='"'?a=!0:m===","?l():m===`
`?(l(),r()):m==="\r"||(t+=m),c++}return l(),r(),h.map(m=>m.map(i=>i.trim())).filter(m=>m.some(i=>i.length))},z=(o,h,c)=>{const t=s.slice();t[o]={...t[o],[h]:c},y(t)},K=()=>y([...s,{type:"communication",height:"",makeReady:!1,makeReadyHeight:"",companyName:""}]),V=o=>y(s.filter((h,c)=>c!==o)),oe=o=>{const h=s.slice(),c={...h[o]};h.splice(o+1,0,c),y(h)},ee=(o,h)=>{const c=o+h;if(c<0||c>=s.length)return;const t=s.slice(),[n]=t.splice(o,1);t.splice(c,0,n),y(t)},re=()=>{const o=q(F||"");if(!o.length)return;const h=o[0];U(h);const c=i=>h.findIndex(u=>u.toLowerCase()===String(i).toLowerCase()),t=c(M.type||"type"),n=c(M.company||"company"),a=c(M.height||"height"),l=c(M.makeReady||"makeReady"),r=c(M.makeReadyHeight||"makeReadyHeight"),m=[];for(let i=1;i<o.length;i++){const u=o[i],p=d=>d>=0&&d<u.length?u[d]:"";m.push({type:p(t)||"communication",companyName:p(n),height:p(a),makeReady:/^(y|yes|true|1)$/i.test(p(l)),makeReadyHeight:p(r)})}m.length&&y(m),$(!1),b("")},de=()=>{const o=["type","company","height","makeReady","makeReadyHeight"],h=s.map(l=>[l.type||"",l.companyName||"",l.height||"",l.makeReady?"true":"false",l.makeReadyHeight||""]),c=[o.join(","),...h.map(l=>l.map(r=>`${String(r).replaceAll('"','""')}`).join(","))].join(`
`),t=new Blob([c],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="existing-lines.csv",a.click(),URL.revokeObjectURL(n)},te=o=>{if(!o.makeReady||!o.makeReadyHeight||!o.height)return 0;const h=B(o.height),c=B(o.makeReadyHeight);return h==null||c==null?0:Math.round((c-h)*12)},ne=o=>Math.abs(te(o))*12.5,X=s.reduce((o,h)=>o+ne(h),0),se=()=>{const o=s.reduce((r,m)=>{if(!m.makeReady)return r;const i=m.companyName||"—",u=Math.abs(Math.round(((B(m.makeReadyHeight)||0)-(B(m.height)||0))*12)),p=u*12.5,d=r[i]||{rows:0,deltaInches:0,totalCost:0};return d.rows+=1,d.deltaInches+=u,d.totalCost+=p,r[i]=d,r},{}),h=["company","rows","deltaInches","totalCost"],c=Object.entries(o).map(([r,m])=>[r,m.rows,m.deltaInches,m.totalCost]),t=[h.join(","),...c.map(r=>r.join(","))].join(`
`),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),l=document.createElement("a");l.href=a,l.download="make-ready-summary.csv",l.click(),URL.revokeObjectURL(a)};return e.jsxs("div",{className:"rounded border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium",children:"Existing Lines"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>$(o=>!o),className:"text-sm px-2 py-1 border rounded",children:G?"Hide CSV":"Import CSV"}),e.jsx("button",{onClick:de,className:"text-sm px-2 py-1 border rounded",children:"Export CSV"}),e.jsx("button",{onClick:se,className:"text-sm px-2 py-1 border rounded",children:"Export Summary"}),e.jsx("button",{onClick:()=>y([]),className:"text-sm px-2 py-1 border rounded",children:"Clear"}),e.jsx("button",{onClick:K,className:"text-sm px-2 py-1 border rounded",children:"Add"})]})]}),G&&e.jsxs("div",{className:"mb-2",children:[e.jsx("textarea",{className:"w-full h-28 border rounded p-2 text-xs",placeholder:"Paste CSV with headers: type,company,height,makeReady,makeReadyHeight",value:F,onChange:o=>b(o.target.value)}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("button",{onClick:()=>H(!0),className:"text-sm px-2 py-1 border rounded",children:"Map Columns"}),e.jsx("button",{onClick:()=>{const o=q(F||"");if(!o.length)return;const h=o[0].map(t=>t.toLowerCase()),c=t=>{for(const n of t){const a=h.indexOf(n);if(a>=0)return o[0][a]}for(const n of o[0])if(t.some(a=>n.toLowerCase().includes(a)))return n;return""};Y({type:c(["type","linetype","category"]),company:c(["company","owner","provider"]),height:c(["height","ht","hgt"]),makeReady:c(["makeready","mr","mr_flag"]),makeReadyHeight:c(["newheight","mr_height","mrh","makereadyheight"])})},className:"text-sm px-2 py-1 border rounded",children:"Auto-map Headers"}),e.jsx("button",{onClick:re,className:"text-sm px-2 py-1 border rounded",children:"Use CSV"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Replaces current table"})]})]}),e.jsx("div",{className:"overflow-auto break-anywhere",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600",children:[e.jsx("th",{className:"p-2",children:"Type"}),e.jsx("th",{className:"p-2",children:"Owner"}),e.jsx("th",{className:"p-2",children:"Height (ft/in)"}),e.jsx("th",{className:"p-2",children:"Make‑ready?"}),e.jsx("th",{className:"p-2",children:"New Height (ft/in)"}),e.jsx("th",{className:"p-2",children:"Δ / Est. Cost"}),e.jsx("th",{className:"p-2"})]})}),e.jsx("tbody",{children:s.map((o,h)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:e.jsxs("select",{className:"border rounded px-2 py-1",value:o.type,onChange:c=>z(h,"type",c.target.value),children:[e.jsx("option",{value:"",children:"Select"}),Ce.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))]})}),e.jsxs("td",{className:"p-2",children:[e.jsx("input",{list:"wv-companies",className:"border rounded px-2 py-1",value:o.companyName||"",onChange:c=>z(h,"companyName",c.target.value),placeholder:"e.g., Mon Power (Owner)"}),e.jsxs("datalist",{id:"wv-companies",children:[he.power.map(c=>e.jsx("option",{value:c.short||c.name,children:c.name},`p-${c.name}`)),he.communication.map(c=>e.jsx("option",{value:c.short||c.name,children:c.name},`c-${c.name}`))]}),e.jsx("div",{className:"text-[10px] text-gray-500 mt-0.5",children:"Tip: Use FE subsidiary names (Mon Power, Penelec, etc.) for FE rules."})]}),e.jsx("td",{className:"p-2",children:e.jsx("input",{className:`border rounded px-2 py-1 ${o.height&&B(o.height)==null?"border-red-400 bg-red-50":""}`,value:o.height||"",onChange:c=>z(h,"height",c.target.value),placeholder:`e.g., 18' 6"`})}),e.jsx("td",{className:"p-2",children:e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:!!o.makeReady,onChange:c=>z(h,"makeReady",c.target.checked)}),e.jsx("span",{children:"Yes"})]})}),e.jsxs("td",{className:"p-2",children:[e.jsx("input",{className:`border rounded px-2 py-1 ${o.makeReady&&o.makeReadyHeight&&B(o.makeReadyHeight)==null?"border-red-400 bg-red-50":""}`,value:o.makeReadyHeight||"",disabled:!o.makeReady,onChange:c=>z(h,"makeReadyHeight",c.target.value),placeholder:`e.g., 19' 6"`}),o.makeReady&&o.makeReadyHeight&&o.height&&B(o.makeReadyHeight)!=null&&B(o.height)!=null?e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Δ"," ",J(B(o.makeReadyHeight)-B(o.height))]}):null]}),e.jsx("td",{className:"p-2 whitespace-nowrap text-xs text-gray-700",children:o.makeReady?e.jsxs(e.Fragment,{children:[te(o),'" / $',ne(o)]}):"—"}),e.jsx("td",{className:"p-2 text-right",children:e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("button",{onClick:()=>ee(h,-1),className:"text-xs",children:"↑"}),e.jsx("button",{onClick:()=>ee(h,1),className:"text-xs",children:"↓"}),e.jsx("button",{onClick:()=>oe(h),className:"text-xs",children:"Duplicate"}),e.jsx("button",{onClick:()=>V(h),className:"text-xs text-red-600",children:"Remove"})]})})]},h))})]})}),e.jsxs("div",{className:"text-xs text-gray-600 mt-2",children:["Rows: ",s.length," | Est. Make‑ready total: $",X]}),s.length?e.jsxs("div",{className:"text-xs text-gray-700 mt-1",children:[e.jsx("div",{className:"font-medium",children:"By company:"}),e.jsx("ul",{className:"list-disc pl-5",children:Object.entries(s.reduce((o,h)=>{if(!h.makeReady)return o;const c=h.companyName||"—";return o[c]=(o[c]||0)+Math.abs(Math.round(((B(h.makeReadyHeight)||0)-(B(h.height)||0))*12))*12.5,o},{})).map(([o,h])=>e.jsxs("li",{children:[o,": $",h]},o))})]}):null,e.jsx(ke,{open:C,onClose:()=>H(!1),headers:O,mapping:M,onChange:Y})]})}function ke({open:s,onClose:y,headers:M,mapping:Y,onChange:P}){if(!s)return null;const J=["type","company","height","makeReady","makeReadyHeight"],G=($,F)=>P({...Y,[$]:F});return e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded shadow-lg w-[90vw] max-w-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium",children:"Map CSV Columns"}),e.jsx("button",{className:"text-sm",onClick:y,children:"Close"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-2 text-sm",children:J.map($=>e.jsxs("label",{className:"grid grid-cols-2 items-center gap-2",children:[e.jsx("span",{className:"text-xs uppercase text-gray-500",children:$}),e.jsxs("select",{className:"border rounded px-2 py-1",value:Y[$]||"",onChange:F=>G($,F.target.value),children:[e.jsx("option",{value:"",children:"—"}),M.map(F=>e.jsx("option",{value:F,children:F},F))]})]},$))}),e.jsx("div",{className:"text-xs text-gray-600 mt-2",children:"Tip: set once and it’s remembered."})]})})}function fe({segments:s,onChange:y}){const[M,Y]=R.useState(!1),P=s||[],J=(b,C)=>{const H=P.slice();H[b]={...H[b]||{},...C},y(H)},G=()=>y([...P||[],{id:`seg-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,env:"road",portion:100-(P||[]).reduce((b,C)=>b+(Number(C.portion)||0),0)}]),$=b=>y((P||[]).filter((C,H)=>H!==b)),F=(P||[]).reduce((b,C)=>b+(Number(C.portion)||0),0);return e.jsxs("div",{children:[e.jsx("button",{className:"px-2 py-0.5 border rounded text-xs",onClick:()=>Y(b=>!b),children:M?"Hide":"Edit"}),M&&e.jsxs("div",{className:"mt-1 space-y-1",children:[P.length?P.map((b,C)=>{var H,O,U;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"border rounded px-1 py-0.5 text-xs",value:b.env||"",onChange:q=>J(C,{env:q.target.value}),children:[e.jsx("option",{value:"road",children:"Road"}),e.jsx("option",{value:"residential",children:"Residential"}),e.jsx("option",{value:"pedestrian",children:"Pedestrian"}),e.jsx("option",{value:"field",children:"Field"}),e.jsx("option",{value:"residentialYard",children:"Residential Yard"}),e.jsx("option",{value:"residentialDriveway",children:"Residential Driveway"}),e.jsx("option",{value:"nonResidentialDriveway",children:"Non-Residential Driveway"}),e.jsx("option",{value:"waterway",children:"Waterway"}),e.jsx("option",{value:"interstate",children:"Interstate"}),e.jsx("option",{value:"interstateNewCrossing",children:"Interstate (New Crossing)"}),e.jsx("option",{value:"wvHighway",children:"WV Highway"}),e.jsx("option",{value:"railroad",children:"Railroad"})]}),e.jsx("input",{className:"border rounded px-1 py-0.5 w-16 text-xs",type:"number",min:"0",max:"100",step:"1",value:(H=b.portion)!=null?H:"",onChange:q=>J(C,{portion:Number(q.target.value)}),placeholder:"%"}),e.jsx("button",{className:"px-1 py-0.5 border rounded text-xs",onClick:()=>$(C),children:"x"})]},(U=b.id)!=null?U:`${b.env||"env"}-${(O=b.portion)!=null?O:""}`)}):e.jsx("div",{className:"text-xs text-gray-500",children:"No segments"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"px-2 py-0.5 border rounded text-xs",onClick:G,children:"Add"}),e.jsxs("span",{className:`text-[10px] ${F>100?"text-red-600":"text-gray-600"}`,children:["Total: ",F,"%"]})]})]})]})}fe.propTypes={segments:xe.array,onChange:xe.func.isRequired};function Me(){var c;const s=ge(),y=R.useMemo(()=>s.importedSpans||[],[s.importedSpans]),[M,Y]=R.useState(null),[P,J]=R.useState(!1),[G,$]=R.useState(!1),F=(t,n)=>{s.updateImportedSpan(t,{environment:n})},b=R.useCallback(()=>{const t=(s.jobs||[]).find(l=>l.id===s.currentJobId),n=(t==null?void 0:t.submissionProfileName)||s.currentSubmissionProfile;return{...(s.submissionProfiles||[]).find(l=>l.name===n)||{},...(t==null?void 0:t.submissionProfileOverrides)||{}}},[s.jobs,s.currentJobId,s.currentSubmissionProfile,s.submissionProfiles]),C=R.useCallback((t,n)=>Ne(b(),t,n),[b]),H=R.useCallback(()=>[...s.importedPoles||[],...s.collectedPoles||[]].map(n=>({id:n.id||n.poleId||n.name||"",latitude:typeof n.latitude=="number"?n.latitude:Number(n.latitude),longitude:typeof n.longitude=="number"?n.longitude:Number(n.longitude),jobId:n.jobId||""})).filter(n=>n.id&&Number.isFinite(n.latitude)&&Number.isFinite(n.longitude)),[s.importedPoles,s.collectedPoles]),O=R.useCallback(()=>{const t=new Map;for(const n of H())t.set(String(n.id),n);return t},[H]),U=R.useCallback((t,n,a,l)=>{const r=v=>v*Math.PI/180,i=r((a||0)-(t||0)),u=r((l||0)-(n||0)),p=Math.sin(i/2)**2+Math.cos(r(t||0))*Math.cos(r(a||0))*Math.sin(u/2)**2;return 6371e3*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))*3.28084},[]),q=(t,n)=>!t||!n?null:{lat:(t.latitude+n.latitude)/2,lon:(t.longitude+n.longitude)/2},z=R.useCallback(t=>{if(!t)return;const n=O(),a=t.fromId!=null?n.get(String(t.fromId)):void 0,l=t.toId!=null?n.get(String(t.toId)):void 0;if(a&&l){const r=U(a.latitude,a.longitude,l.latitude,l.longitude);return Number.isFinite(r)?Math.round(r):void 0}},[O,U]),K=t=>{const n=O(),a=d=>d!=null?n.get(String(d)):void 0;let l=a(t.fromId),r=a(t.toId),m=l&&r?q(l,r):null;if(l&&r){const d=q(l,r);return{from:{id:l.id,lat:l.latitude,lon:l.longitude},to:{id:r.id,lat:r.latitude,lon:r.longitude},mid:d?{lat:d.lat,lon:d.lon}:null}}let i=m;if(!i){const d=Number(s.poleLatitude),x=Number(s.poleLongitude);Number.isFinite(d)&&Number.isFinite(x)&&(i={lat:d,lon:x})}const u=Array.from(n.values());if(i&&u.length>=2){const d=u.map(x=>({p:x,d:U(i.lat,i.lon,x.latitude,x.longitude)})).sort((x,v)=>x.d-v.d).slice(0,2).map(x=>x.p);!l&&d[0]&&(t.fromId=d[0].id),!r&&d[1]&&(t.toId=d[1].id),l=a(t.fromId),r=a(t.toId)}const p=l&&r?q(l,r):null;return{from:l?{id:l.id,lat:l.latitude,lon:l.longitude}:null,to:r?{id:r.id,lat:r.latitude,lon:r.longitude}:null,mid:p?{lat:p.lat,lon:p.lon}:null}},V=R.useMemo(()=>{const t=O(),n=i=>{if(!i)return;const u=x=>x!=null?t.get(String(x)):void 0,p=u(i.fromId),d=u(i.toId);if(p&&d){const x=U(p.latitude,p.longitude,d.latitude,d.longitude);return Number.isFinite(x)?Math.round(x):void 0}};function a(i){var N,L,D,I,E;const u=n(i),d=!!i.lengthFt?Number(i.lengthFt):null,x=s.preferAutoSpanLength?u||d||0:d||u||0,v=u!=null&&d!=null?Math.abs(u-d):0,A=v>=(Number(s.spanLenDeltaThresholdFt)||10),_=!!(i.fromId&&i.toId);let S=null,T=null;try{const k=ie({poleHeight:s.poleHeight||35,existingPowerHeight:s.existingPowerHeight||"",existingPowerVoltage:s.existingPowerVoltage||"distribution",spanDistance:x,isNewConstruction:s.isNewConstruction,adjacentPoleHeight:s.adjacentPoleHeight||s.poleHeight||35,attachmentType:s.attachmentType,cableDiameter:s.cableDiameter,windSpeed:s.windSpeed,spanEnvironment:i.environment||s.spanEnvironment,dripLoopHeight:s.dripLoopHeight,proposedLineHeight:s.proposedLineHeight,existingLines:s.existingLines,iceThicknessIn:s.iceThicknessIn,hasTransformer:s.hasTransformer,presetProfile:s.presetProfile,customMinTopSpace:s.customMinTopSpace,customRoadClearance:s.customRoadClearance,customCommToPower:s.customCommToPower,powerReference:s.powerReference,jobOwner:s.jobOwner,submissionProfile:b()}),f=(D=C(i.segments,i.environment||s.spanEnvironment))!=null?D:(L=(N=k==null?void 0:k.results)==null?void 0:N.clearances)==null?void 0:L.groundClearance,j=(E=(I=k==null?void 0:k.results)==null?void 0:I.span)==null?void 0:E.midspanFt;j!=null&&f!=null&&(S=Number(j)>=Number(f),T=!S)}catch{}return{...i,autoLen:u,manualLen:d,shownLen:x,delta:v,bigDelta:A,endpoints:_,pass:S,fail:T}}const l=y.map(a),r={total:l.length,withEndpoints:l.filter(i=>i.endpoints).length,autoAvailable:l.filter(i=>i.autoLen).length,manualCount:l.filter(i=>i.manualLen!=null).length,pass:l.filter(i=>i.pass===!0).length,fail:l.filter(i=>i.fail===!0).length},m={"≤5ft":l.filter(i=>i.delta<=5).length,"6–15ft":l.filter(i=>i.delta>5&&i.delta<=15).length,"16–30ft":l.filter(i=>i.delta>15&&i.delta<=30).length,">30ft":l.filter(i=>i.delta>30).length};return{list:l,counts:r,buckets:m}},[y,s.preferAutoSpanLength,s.spanLenDeltaThresholdFt,s.poleHeight,s.existingPowerHeight,s.existingPowerVoltage,s.isNewConstruction,s.adjacentPoleHeight,s.attachmentType,s.cableDiameter,s.windSpeed,s.spanEnvironment,s.dripLoopHeight,s.proposedLineHeight,s.existingLines,s.iceThicknessIn,s.hasTransformer,s.presetProfile,s.customMinTopSpace,s.customRoadClearance,s.customCommToPower,s.powerReference,s.jobOwner,C,b,O,U]),oe=t=>{const n=V.list[t];return!(P&&(n==null?void 0:n.pass)!==!1||G&&!(n!=null&&n.bigDelta))},ee=(t,n,a)=>t&&a?"auto":n.lengthFt?"manual":n.estimatedLengthFt?"est":a?"auto*":"—",re=(t,n,a)=>t&&a?"Using auto length from coordinates":n.lengthFt?"Using manual length":n.estimatedLengthFt?"Using estimated length":a?"Auto length available":"No length available",de=(t,n,a)=>{var l,r,m,i,u;try{const p=n?a||t.lengthFt||t.estimatedLengthFt||0:t.lengthFt||t.estimatedLengthFt||a||0,d=ie(X(t,p)),x=(m=C(t.segments,t.environment||s.spanEnvironment))!=null?m:(r=(l=d==null?void 0:d.results)==null?void 0:l.clearances)==null?void 0:r.groundClearance,v=(u=(i=d==null?void 0:d.results)==null?void 0:i.span)==null?void 0:u.midspanFt;if(v!=null&&x!=null)return Number(v)>=Number(x)}catch{}return null},te=(t,n)=>{var a,l,r,m,i;try{const u=ie(X(t,n||0)),p=(r=C(t.segments,t.environment||s.spanEnvironment))!=null?r:(l=(a=u==null?void 0:u.results)==null?void 0:a.clearances)==null?void 0:l.groundClearance,d=(i=(m=u==null?void 0:u.results)==null?void 0:m.span)==null?void 0:i.midspanFt,x=d!=null&&p!=null?Number(d)>=Number(p):null;return{mid:d,target:p,ok:x}}catch{return{mid:null,target:null,ok:null}}},ne=(t,n,a)=>{var l,r,m,i,u,p,d,x;return t&&n&&a?`auto: ${t} ft
from (${(r=(l=n.latitude)==null?void 0:l.toFixed)==null?void 0:r.call(l,6)}, ${(i=(m=n.longitude)==null?void 0:m.toFixed)==null?void 0:i.call(m,6)})
to   (${(p=(u=a.latitude)==null?void 0:u.toFixed)==null?void 0:p.call(u,6)}, ${(x=(d=a.longitude)==null?void 0:d.toFixed)==null?void 0:x.call(d,6)})`:""},X=(t,n)=>({poleHeight:s.poleHeight||35,existingPowerHeight:s.existingPowerHeight||"",existingPowerVoltage:s.existingPowerVoltage||"distribution",spanDistance:n,isNewConstruction:s.isNewConstruction,adjacentPoleHeight:s.adjacentPoleHeight||s.poleHeight||35,attachmentType:s.attachmentType,cableDiameter:s.cableDiameter,windSpeed:s.windSpeed,spanEnvironment:t.environment||s.spanEnvironment,dripLoopHeight:s.dripLoopHeight,proposedLineHeight:s.proposedLineHeight,existingLines:s.existingLines,iceThicknessIn:s.iceThicknessIn,hasTransformer:s.hasTransformer,presetProfile:s.presetProfile,customMinTopSpace:s.customMinTopSpace,customRoadClearance:s.customRoadClearance,customCommToPower:s.customCommToPower,powerReference:s.powerReference,jobOwner:s.jobOwner,submissionProfile:b()}),se=(t,n,a)=>t?n?"auto":a.lengthFt?"lengthFt":a.estimatedLengthFt?"estimatedLengthFt":"unknown":a.lengthFt?"lengthFt":a.estimatedLengthFt?"estimatedLengthFt":n?"auto":"unknown",o=t=>{var u,p,d,x,v,A,_,S,T,N,L,D,I,E,k,f,j,Q,w;const n=y[t],a=z(n),l=!!s.preferAutoSpanLength,r=se(l,a,n),m=l?a||n.lengthFt||n.estimatedLengthFt||0:n.lengthFt||n.estimatedLengthFt||a||0,i=ie(X(n,m));if(i!=null&&i.results){const W=C(n.segments,n.environment||s.spanEnvironment),g=K(n),ae={};(n.fromId==null||n.fromId==="")&&((u=g==null?void 0:g.from)!=null&&u.id)&&(ae.fromId=g.from.id),(n.toId==null||n.toId==="")&&((p=g==null?void 0:g.to)!=null&&p.id)&&(ae.toId=g.to.id),Object.keys(ae).length&&s.updateImportedSpan(t,ae);const ce=i.results.span.midspanFt,me=W!=null?W:i.results.clearances.groundClearance;let le=null;ce!=null&&me!=null&&(le=Number(ce)>=Number(me));const be=le===!1?Math.max(0,Number(me)-Number(ce)):le===!0?0:null,ue=n.lengthFt!=null?Number(n.lengthFt):null,pe=(d=z(n))!=null?d:null,ye=ue!=null&&pe!=null?Math.abs(ue-pe):null;s.addCachedMidspan({spanId:n.id||`${t+1}`,environment:n.environment||s.spanEnvironment,spanFt:i.results.span.spanFt,midspanFt:i.results.span.midspanFt,targetFt:W!=null?W:i.results.clearances.groundClearance,attachFt:i.results.attach.proposedAttachFt,segments:Array.isArray(n.segments)?n.segments:null,spanLenSource:r,pass:le,deficitFt:be,deltaFt:ye,midLat:(v=(x=g==null?void 0:g.mid)==null?void 0:x.lat)!=null?v:"",midLon:(_=(A=g==null?void 0:g.mid)==null?void 0:A.lon)!=null?_:"",fromId:(T=(S=g==null?void 0:g.from)==null?void 0:S.id)!=null?T:"",toId:(L=(N=g==null?void 0:g.to)==null?void 0:N.id)!=null?L:"",fromLat:(I=(D=g==null?void 0:g.from)==null?void 0:D.lat)!=null?I:"",fromLon:(k=(E=g==null?void 0:g.from)==null?void 0:E.lon)!=null?k:"",toLat:(j=(f=g==null?void 0:g.to)==null?void 0:f.lat)!=null?j:"",toLon:(w=(Q=g==null?void 0:g.to)==null?void 0:Q.lon)!=null?w:""})}},h=t=>{var d,x,v,A,_,S,T,N,L,D,I,E,k,f,j,Q,w,W,g;const n=y[t],a=K(n),l=z(n),r=!!s.preferAutoSpanLength,m=se(r,l,n),i={};(n.fromId==null||n.fromId==="")&&((d=a==null?void 0:a.from)!=null&&d.id)&&(i.fromId=a.from.id),(n.toId==null||n.toId==="")&&((x=a==null?void 0:a.to)!=null&&x.id)&&(i.toId=a.to.id),Object.keys(i).length&&s.updateImportedSpan(t,i);const u=n.lengthFt!=null?Number(n.lengthFt):null,p=u!=null&&l!=null?Math.abs(u-l):null;s.addCachedMidspan({spanId:n.id||`${t+1}`,environment:n.environment||s.spanEnvironment,spanFt:r?l||n.lengthFt||n.estimatedLengthFt||0:n.lengthFt||n.estimatedLengthFt||l||0,midspanFt:null,targetFt:(v=C(n.segments,n.environment||s.spanEnvironment))!=null?v:null,attachFt:null,segments:Array.isArray(n.segments)?n.segments:null,spanLenSource:m,pass:null,deficitFt:null,deltaFt:p,midLat:(_=(A=a==null?void 0:a.mid)==null?void 0:A.lat)!=null?_:"",midLon:(T=(S=a==null?void 0:a.mid)==null?void 0:S.lon)!=null?T:"",fromId:(L=(N=a==null?void 0:a.from)==null?void 0:N.id)!=null?L:"",toId:(I=(D=a==null?void 0:a.to)==null?void 0:D.id)!=null?I:"",fromLat:(k=(E=a==null?void 0:a.from)==null?void 0:E.lat)!=null?k:"",fromLon:(j=(f=a==null?void 0:a.from)==null?void 0:f.lon)!=null?j:"",toLat:(w=(Q=a==null?void 0:a.to)==null?void 0:Q.lat)!=null?w:"",toLon:(g=(W=a==null?void 0:a.to)==null?void 0:W.lon)!=null?g:""})};return y.length?e.jsxs("div",{className:"rounded border p-3 no-print",children:[e.jsx("div",{className:"font-medium mb-2",children:"Spans (Per‑span Environment & Quick Calc)"}),e.jsxs("div",{className:"mb-2 grid grid-cols-1 md:grid-cols-3 gap-2 text-xs md:text-sm",children:[e.jsxs("div",{className:"border rounded p-2",children:[e.jsx("div",{className:"font-medium mb-1",children:"Status"}),e.jsxs("div",{children:["Total: ",V.counts.total]}),e.jsxs("div",{children:["With endpoints: ",V.counts.withEndpoints]}),e.jsxs("div",{children:["Auto available: ",V.counts.autoAvailable]}),e.jsxs("div",{children:["Manual lengths: ",V.counts.manualCount]})]}),e.jsxs("div",{className:"border rounded p-2",children:[e.jsx("div",{className:"font-medium mb-1",children:"Compliance"}),e.jsxs("div",{className:"text-emerald-700",children:["PASS: ",V.counts.pass]}),e.jsxs("div",{className:"text-red-700",children:["FAIL: ",V.counts.fail]})]}),e.jsxs("div",{className:"border rounded p-2",children:[e.jsx("div",{className:"font-medium mb-1",children:"Δ buckets (manual vs auto)"}),e.jsxs("div",{children:["≤5ft: ",V.buckets["≤5ft"]]}),e.jsxs("div",{children:["6–15ft: ",V.buckets["6–15ft"]]}),e.jsxs("div",{children:["16–30ft: ",V.buckets["16–30ft"]]}),e.jsxs("div",{children:[">30ft: ",V.buckets[">30ft"]]})]})]}),e.jsxs("div",{className:"mb-2 flex flex-wrap items-center gap-2",children:[e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm text-gray-700",title:"When on, calculations use GPS auto length when available.",children:[e.jsx("input",{type:"checkbox",checked:!!s.preferAutoSpanLength,onChange:t=>s.setPreferAutoSpanLength(t.target.checked)}),e.jsx("span",{className:"ml-1",children:"Prefer auto length"})]}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm text-gray-700",title:"Row density affects padding and font size",children:[e.jsx("span",{className:"mr-1",children:"Density"}),e.jsxs("select",{className:"border rounded px-1 py-0.5 text-xs",value:s.tableDensity,onChange:t=>s.setTableDensity(t.target.value),children:[e.jsx("option",{value:"comfortable",children:"Comfortable"}),e.jsx("option",{value:"compact",children:"Compact"})]})]}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm text-gray-700",title:"Show only FAIL rows based on midspan vs target",children:[e.jsx("input",{type:"checkbox",checked:P,onChange:t=>J(t.target.checked)}),e.jsx("span",{className:"ml-1",children:"Only FAIL"})]}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm text-gray-700",title:"Show only rows where manual vs auto Δ ≥ threshold",children:[e.jsx("input",{type:"checkbox",checked:G,onChange:t=>$(t.target.checked)}),e.jsx("span",{className:"ml-1",children:"Only big Δ"})]}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm text-gray-700",title:"Show/Hide Segments column",children:[e.jsx("input",{type:"checkbox",checked:!!s.spansColumnSegmentsVisible,onChange:t=>s.setSpansColumnSegmentsVisible(t.target.checked)}),e.jsx("span",{className:"ml-1",children:"Segments"})]}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm text-gray-700",title:"Show/Hide Actions column",children:[e.jsx("input",{type:"checkbox",checked:!!s.spansColumnActionsVisible,onChange:t=>s.setSpansColumnActionsVisible(t.target.checked)}),e.jsx("span",{className:"ml-1",children:"Actions"})]}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm text-gray-700",title:"Highlight Δ badge when manual vs auto length differs by this amount or more.",children:[e.jsx("span",{className:"mr-1",children:"Δ threshold (ft)"}),e.jsx("input",{className:"border rounded px-1 py-0.5 w-16 text-xs",type:"number",min:"0",step:"1",value:(c=s.spanLenDeltaThresholdFt)!=null?c:10,onChange:t=>s.setSpanLenDeltaThresholdFt(t.target.value)})]}),!!(s.cachedMidspans||[]).length&&e.jsx("button",{className:"px-2 py-0.5 border rounded text-sm",onClick:()=>{var m,i,u,p,d,x,v,A,_,S,T,N,L,D,I,E,k;const t=[["spanId","environment","spanFt","spanLenSource","midspanFt","targetFt","attachFt","pass","deficitFt","deltaFt","midLat","midLon","fromId","toId","fromLat","fromLon","toLat","toLon","segments"]];for(const f of s.cachedMidspans||[])t.push([(m=f.spanId)!=null?m:"",(i=f.environment)!=null?i:"",(u=f.spanFt)!=null?u:"",(p=f.spanLenSource)!=null?p:"",(d=f.midspanFt)!=null?d:"",(x=f.targetFt)!=null?x:"",(v=f.attachFt)!=null?v:"",f.pass===!0?"PASS":f.pass===!1?"FAIL":"",(A=f.deficitFt)!=null?A:"",(_=f.deltaFt)!=null?_:"",(S=f.midLat)!=null?S:"",(T=f.midLon)!=null?T:"",(N=f.fromId)!=null?N:"",(L=f.toId)!=null?L:"",(D=f.fromLat)!=null?D:"",(I=f.fromLon)!=null?I:"",(E=f.toLat)!=null?E:"",(k=f.toLon)!=null?k:"",Array.isArray(f.segments)?f.segments.map(j=>`${j.env}:${j.portion||""}`).join("|"):""]);const n=t.map(f=>f.map(j=>String(j).replaceAll('"','""')).map(j=>j.includes(",")?`"${j}"`:j).join(",")).join(`
`),a=new Blob([n],{type:"text/csv"}),l=URL.createObjectURL(a),r=document.createElement("a");r.href=l,r.download="cached_midspans.csv",r.click(),URL.revokeObjectURL(l)},children:"Export Cached Midspans (CSV)"}),!!(s.cachedMidspans||[]).length&&e.jsx("button",{className:"px-2 py-0.5 border rounded text-sm",onClick:()=>s.clearCachedMidspans(),children:"Clear Cached Midspans"}),e.jsx("button",{className:"px-2 py-0.5 border rounded text-sm",onClick:()=>{const t=O();(s.importedSpans||[]).forEach((n,a)=>{const l=n.fromId!=null?t.get(String(n.fromId)):void 0,r=n.toId!=null?t.get(String(n.toId)):void 0;if(l&&r){const m=Math.round(U(l.latitude,l.longitude,r.latitude,r.longitude));Number.isFinite(m)&&s.updateImportedSpan(a,{lengthFt:m})}})},children:"Auto‑calc All Lengths"}),e.jsx("button",{className:"px-2 py-0.5 border rounded text-sm",title:"Compute analysis for all spans and add to cache",onClick:()=>{y.forEach((t,n)=>{try{o(n)}catch{}})},children:"Compute All (cache)"}),e.jsx("button",{className:"px-2 py-0.5 border rounded text-sm",title:"Clear cache and recompute for all spans",onClick:()=>{try{s.clearCachedMidspans()}catch{}y.forEach((t,n)=>{try{o(n)}catch{}})},children:"Recompute All"}),e.jsx("button",{className:"px-2 py-0.5 border rounded text-sm",title:"Infer endpoints for spans missing From/To using nearest poles",onClick:()=>{(s.importedSpans||[]).forEach((t,n)=>{var r,m;if(t.fromId&&t.toId)return;const a=K({...t}),l={};!t.fromId&&((r=a==null?void 0:a.from)!=null&&r.id)&&(l.fromId=a.from.id),!t.toId&&((m=a==null?void 0:a.to)!=null&&m.id)&&(l.toId=a.to.id),Object.keys(l).length&&s.updateImportedSpan(n,l)})},children:"Infer Endpoints (All)"}),e.jsx("button",{className:"px-2 py-0.5 border rounded text-sm",title:"Overwrite manual lengths with auto-calculated where endpoints are known",onClick:()=>{const t=O();(s.importedSpans||[]).forEach((n,a)=>{const l=n.fromId!=null?t.get(String(n.fromId)):void 0,r=n.toId!=null?t.get(String(n.toId)):void 0;if(!l||!r)return;const m=Math.round(U(l.latitude,l.longitude,r.latitude,r.longitude));Number.isFinite(m)&&s.updateImportedSpan(a,{lengthFt:m})})},children:"Replace all with auto"})]}),e.jsx("div",{className:"overflow-x-auto break-anywhere",children:e.jsxs("table",{className:`w-full ${s.tableDensity==="compact"?"text-[11px]":"text-xs md:text-sm"}`,children:[e.jsx("thead",{className:"sticky top-0 bg-white z-10",children:e.jsxs("tr",{className:"text-left text-gray-700",children:[e.jsx("th",{className:"p-1",children:"From → To"}),e.jsx("th",{className:"p-1",children:"Env"}),e.jsx("th",{className:"p-1",children:"Len (ft)"}),s.spansColumnSegmentsVisible?e.jsx("th",{className:"p-1",children:"Segments"}):null,e.jsx("th",{className:"p-1",children:"Midspan"}),e.jsx("th",{className:"p-1",children:"Target"}),s.spansColumnActionsVisible?e.jsx("th",{className:"p-1",children:"Actions"}):null]})}),e.jsx("tbody",{children:y.map((t,n)=>{var L,D,I,E,k,f,j,Q;if(!oe(n))return null;const a=z(t),l=!!s.preferAutoSpanLength,r=Math.round(t.lengthFt||t.estimatedLengthFt||0),m=l?a||r||0:r||a||0,i=a&&a!==t.lengthFt,u=O(),p=t.fromId!=null?u.get(String(t.fromId)):void 0,d=t.toId!=null?u.get(String(t.toId)):void 0,x=ne(a,p,d),v=!!t.lengthFt,A=a&&v?Math.abs(Number(a)-Number(t.lengthFt)):0,_=A>=(Number(s.spanLenDeltaThresholdFt)||10),S=de(t,l,a),T=M===n&&a&&p&&d,N=T?te(t,a):null;return e.jsxs("tr",{className:"border-t even:bg-gray-50",children:[e.jsxs("td",{className:`px-2 ${s.tableDensity==="compact"?"py-0.5":"py-1"}`,children:[t.fromId||"?"," → ",t.toId||"?"]}),e.jsx("td",{className:`px-2 ${s.tableDensity==="compact"?"py-0.5":"py-1"}`,children:e.jsxs("select",{className:"border rounded px-1 py-0.5",value:t.environment||"",onChange:w=>F(n,w.target.value),children:[e.jsx("option",{value:"",children:"(job default)"}),e.jsx("option",{value:"road",children:"Road"}),e.jsx("option",{value:"residential",children:"Residential"}),e.jsx("option",{value:"pedestrian",children:"Pedestrian"}),e.jsx("option",{value:"field",children:"Field"}),e.jsx("option",{value:"residentialYard",children:"Residential Yard"}),e.jsx("option",{value:"residentialDriveway",children:"Residential Driveway"}),e.jsx("option",{value:"nonResidentialDriveway",children:"Non-Residential Driveway"}),e.jsx("option",{value:"waterway",children:"Waterway"}),e.jsx("option",{value:"interstate",children:"Interstate"}),e.jsx("option",{value:"interstateNewCrossing",children:"Interstate (New Crossing)"}),e.jsx("option",{value:"wvHighway",children:"WV Highway"}),e.jsx("option",{value:"railroad",children:"Railroad"})]})}),e.jsx("td",{className:`px-2 ${s.tableDensity==="compact"?"py-0.5":"py-1"}`,children:e.jsxs("span",{title:x,className:"relative inline-flex items-center",children:[m,e.jsx("span",{className:"ml-1 text-[10px] px-1 py-0.5 rounded border bg-gray-50 text-gray-600",title:re(l,t,a),children:ee(l,t,a)}),a&&v?e.jsxs("span",{className:`ml-1 text-[10px] px-1 py-0.5 rounded border ${_?"bg-red-50 text-red-700 border-red-300":"bg-gray-50 text-gray-600"}`,title:`Δ between manual and auto: ${A} ft`,children:["Δ ",A,"ft"]}):null,S!=null?e.jsx("span",{className:`ml-1 text-[10px] px-1 py-0.5 rounded border ${S?"bg-emerald-50 text-emerald-700 border-emerald-300":"bg-red-50 text-red-700 border-red-300"}`,title:S?"Midspan ≥ target":"Midspan below target",children:S?"PASS":"FAIL"}):null,a&&p&&d?e.jsx("button",{className:"ml-1 text-xs px-1 py-0.5 border rounded",onClick:w=>{w.preventDefault(),Y(M===n?null:n)},"aria-label":"Details",title:"Show details",children:"i"}):null,T&&N?e.jsxs("div",{className:"absolute z-10 mt-1 left-0 bg-white border rounded shadow p-2 text-xs w-64",children:[e.jsx("div",{className:"font-medium mb-1",children:"Auto length"}),e.jsxs("div",{className:"mb-1",children:[a," ft"]}),e.jsxs("div",{className:"text-gray-600",children:["From: ",(D=(L=p.latitude)==null?void 0:L.toFixed)==null?void 0:D.call(L,6),","," ",(E=(I=p.longitude)==null?void 0:I.toFixed)==null?void 0:E.call(I,6)]}),e.jsxs("div",{className:"text-gray-600",children:["To: ",(f=(k=d.latitude)==null?void 0:k.toFixed)==null?void 0:f.call(k,6),","," ",(Q=(j=d.longitude)==null?void 0:j.toFixed)==null?void 0:Q.call(j,6)]}),e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{children:["Midspan:"," ",N.mid!=null?Z(N.mid):"—"," ","vs Target:"," ",N.target!=null?Z(N.target):"—"]}),e.jsx("div",{className:N.ok==null?"text-gray-600":N.ok?"text-emerald-700":"text-red-700",children:N.ok==null?"—":N.ok?"PASS":"FAIL"})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{className:"px-2 py-0.5 border rounded",onClick:async()=>{var w,W;try{const g=`fromId=${t.fromId||""},toId=${t.toId||""},fromLat=${p.latitude},fromLon=${p.longitude},toLat=${d.latitude},toLon=${d.longitude},autoFt=${a}`;await((W=(w=navigator.clipboard)==null?void 0:w.writeText)==null?void 0:W.call(w,g))}catch{}},children:"Copy"}),e.jsx("a",{className:"px-2 py-0.5 border rounded inline-block",target:"_blank",rel:"noreferrer",href:`https://maps.google.com/?q=${p.latitude},${p.longitude}`,children:"From Map"}),e.jsx("a",{className:"px-2 py-0.5 border rounded inline-block",target:"_blank",rel:"noreferrer",href:`https://maps.google.com/?q=${d.latitude},${d.longitude}`,children:"To Map"}),i?e.jsx("button",{className:"px-2 py-0.5 border rounded",title:"Set manual length to auto",onClick:()=>{s.updateImportedSpan(n,{lengthFt:a})},children:"Use auto"}):null]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsx("button",{className:"px-2 py-0.5 border rounded",onClick:()=>Y(null),children:"Close"})})]}):null,i&&e.jsx("button",{className:"ml-2 px-1 py-0.5 border rounded text-xs",onClick:()=>s.updateImportedSpan(n,{lengthFt:a}),title:"Set length from coordinates",children:"set"})]})}),s.spansColumnSegmentsVisible?e.jsx("td",{className:`px-2 ${s.tableDensity==="compact"?"py-0.5":"py-1"}`,children:e.jsx(fe,{segments:Array.isArray(t.segments)?t.segments:[],onChange:w=>s.updateImportedSpan(n,{segments:w})})}):null,e.jsx("td",{className:`px-2 ${s.tableDensity==="compact"?"py-0.5":"py-1"}`,children:"—"}),e.jsx("td",{className:`px-2 ${s.tableDensity==="compact"?"py-0.5":"py-1"}`,children:(()=>{const w=C(t.segments,t.environment||s.spanEnvironment);return w!=null?Z(w):"—"})()}),s.spansColumnActionsVisible?e.jsxs("td",{className:`px-2 ${s.tableDensity==="compact"?"py-0.5":"py-1"} flex gap-2`,children:[e.jsx("button",{className:"px-2 py-0.5 border rounded",onClick:()=>o(n),children:"Calculate"}),e.jsx("button",{className:"px-2 py-0.5 border rounded",onClick:()=>h(n),children:"Save"})]}):null]},t.id?t.id:`span-${n}`)})})]})}),!!(s.cachedMidspans||[]).length&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"font-medium",children:"Cached Midspans"}),e.jsx("ul",{className:"list-disc pl-5 text-xs text-gray-700",children:(s.cachedMidspans||[]).map(t=>{const n=t.midspanFt!=null&&t.targetFt!=null?Number(t.midspanFt)>=Number(t.targetFt):null;let a="",l="";return n!=null&&(a=n?"PASS":"FAIL",l=n?"ml-1 text-emerald-700":"ml-1 text-red-700"),e.jsxs("li",{children:["Span ",t.spanId,": ",t.spanFt," ft — midspan"," ",t.midspanFt!=null?Z(t.midspanFt):"—"," vs target"," ",t.targetFt!=null?Z(t.targetFt):"—"," (",t.environment||"default",")",a?e.jsxs("span",{className:l,children:["— ",a]}):null]},t.id)})})]})]}):null}export{Re as E,Me as S};
//# sourceMappingURL=app-editors-DF1OQL1O.js.map
